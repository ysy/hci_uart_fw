name: Build Zephyr HCI USB CDC
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install West and OS Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake ccache dtc wget tar
          pip install west

      - name: Checkout Zephyr Source (v3.7.0)
        run: |
          # 裸机拉取源码，绝不依赖会报错的 action-zephyr-setup
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr v3.7.0 zephyr-workspace
          cd zephyr-workspace
          west update
          west zephyr-export
          pip install -r zephyr/scripts/requirements.txt

      - name: Install Zephyr SDK (v0.16.8)
        run: |
          # 直接手动下载并安装 SDK，彻底绕过路径丢失的玄学问题
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          tar -xf zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.8
          # -t 指定交叉编译链，-h 安装主机工具，-c 注册 CMake
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Configure and Build Firmware
        run: |
          cd zephyr-workspace
          mkdir -p custom_config
          
          # 1. 核心配置文件
          cat <<EOF > custom_config/overlay.conf
          CONFIG_USB_DEVICE_STACK=y
          CONFIG_USB_DEVICE_PRODUCT="nRF52840 HCI UART"
          CONFIG_USB_DEVICE_VID=0x1915
          CONFIG_USB_DEVICE_PID=0x520F
          CONFIG_USB_CDC_ACM=y
          CONFIG_BT_UART=y
          CONFIG_UART_INTERRUPT_DRIVEN=y
          CONFIG_UART_LINE_CTRL=y
          # 彻底禁用日志，确保 HCI 纯净
          CONFIG_LOG=n
          CONFIG_CONSOLE=n
          CONFIG_UART_CONSOLE=n
          CONFIG_PRINTK=n
          CONFIG_BOOT_BANNER=n
          EOF

          # 2. 设备树重定向文件
          cat <<EOF > custom_config/app.overlay
          / {
              chosen {
                  zephyr,bt-uart = &cdc_acm_uart0;
              };
          };
          &zephyr_udc0 {
              cdc_acm_uart0: cdc_acm_uart0 {
                  compatible = "zephyr,cdc-acm-uart";
              };
          };
          EOF

          # 3. 编译
          west build -b nrf52840dongle/nrf52840 zephyr/samples/bluetooth/hci_uart -- \
            -DOVERLAY_CONFIG=$(pwd)/custom_config/overlay.conf \
            -DDTC_OVERLAY_FILE=$(pwd)/custom_config/app.overlay

      - name: Upload Hex Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zephyr-hci-cdc-hex
          path: zephyr-workspace/build/zephyr/zephyr.hex
