name: Build Zephyr HCI USB CDC
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install OS Dependencies
        run: |
          sudo apt-get update
          # æ·»åŠ äº†æ‰€æœ‰åº•å±‚ç¼–è¯‘åˆšéœ€ï¼Œä¿®æ­£äº† device-tree-compiler
          sudo apt-get install -y ninja-build cmake ccache device-tree-compiler wget tar xz-utils gperf python3-dev
          pip install west

      - name: Checkout Zephyr Source
        run: |
          # è£¸æœºæ‹‰å–ï¼Œç»ä¸ä¾èµ–ç¬¬ä¸‰æ–¹å¯èƒ½æŠ¥é”™çš„ action
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr v3.7.0 zephyr-workspace
          cd zephyr-workspace
          west update
          west zephyr-export
          pip install -r zephyr/scripts/requirements.txt

      - name: Install Zephyr SDK
        run: |
          # ç›´æ¥ä¸‹è½½å®˜æ–¹åŸç”Ÿ SDK å·¥å…·é“¾åˆ°ç”¨æˆ·ä¸»ç›®å½•
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          tar -xf zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Configure and Build Firmware
        run: |
          # ğŸš¨ ç»ˆæä¿é™©ï¼šå¼ºè¡Œæ³¨å…¥ç¯å¢ƒå˜é‡ï¼ŒCMake ç»å¯¹ä¸å¯èƒ½å†æŠ¥ "SDK not found"
          export ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.16.8
          export ZEPHYR_TOOLCHAIN_VARIANT=zephyr
          
          cd zephyr-workspace
          mkdir -p custom_config
          
          # 1. æ ¸å¿ƒé…ç½®æ–‡ä»¶
          cat <<EOF > custom_config/overlay.conf
          # --- USB åŸºç¡€æ ˆ ---
          CONFIG_USB_DEVICE_STACK=y
          # ğŸš¨ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶ç³»ç»Ÿä¸Šç”µå³åˆå§‹åŒ– USB ç¡¬ä»¶ï¼Œå¦åˆ™æ’ç”µè„‘æ— ååº”
          CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y
          CONFIG_USB_DEVICE_PRODUCT="nRF52840 HCI UART"
          CONFIG_USB_DEVICE_VID=0x1915
          CONFIG_USB_DEVICE_PID=0x520F
          
          # --- ä¸²å£ä¸ HCI é…ç½® ---
          CONFIG_SERIAL=y
          CONFIG_UART_INTERRUPT_DRIVEN=y
          CONFIG_UART_LINE_CTRL=y
          CONFIG_USB_CDC_ACM=y
          
          # --- å½»åº•æ–­ç»æ‚æ³¢ï¼Œä¿éšœ Bumble è§£æ ---
          CONFIG_LOG=n
          CONFIG_CONSOLE=n
          CONFIG_UART_CONSOLE=n
          CONFIG_PRINTK=n
          CONFIG_BOOT_BANNER=n
          EOF

          # 2. DTS ç¡¬ä»¶æ˜ å°„é‡å®šå‘
          cat <<EOF > custom_config/app.overlay
          / {
              chosen {
                  zephyr,bt-uart = &cdc_acm_uart0;
              };
          };
          &zephyr_udc0 {
              cdc_acm_uart0: cdc_acm_uart0 {
                  compatible = "zephyr,cdc-acm-uart";
              };
          };
          EOF

          # 3. ç¼–è¯‘
          west build -b nrf52840dongle zephyr/samples/bluetooth/hci_uart -- \
            -DOVERLAY_CONFIG="$(pwd)/custom_config/overlay.conf" \
            -DDTC_OVERLAY_FILE="$(pwd)/custom_config/app.overlay"

      - name: Upload Hex Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zephyr-hci-cdc-hex
          path: zephyr-workspace/build/zephyr/zephyr.hex
