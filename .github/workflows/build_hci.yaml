name: Build Zephyr HCI USB CDC
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    # 使用包含 SDK 0.16.8 的稳定版镜像
    container: zephyrprojectrtos/ci:v0.26.11
    # 关键修复：显式注入 SDK 路径和工具链变量
    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 8
      ZEPHYR_SDK_INSTALL_DIR: /opt/toolchains/zephyr-sdk-0.16.8
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr

    steps:
      - name: Checkout Zephyr (Stable v3.7.0)
        run: |
          # 初始化 Zephyr v3.7.0
          west init -m https://github.com/zephyrproject-rtos/zephyr --mr v3.7.0 zephyr-workspace
          cd zephyr-workspace
          west update
          # 注册 Zephyr 包，辅助 CMake 查找
          west zephyr-export

      - name: Build Firmware
        run: |
          cd zephyr-workspace
          
          # 1. 创建配置文件 (关掉 Log 和 Console，确保 HCI 数据纯净)
          mkdir -p custom_overlay
          cat <<EOF > custom_overlay/overlay.conf
          # USB 基础配置
          CONFIG_USB_DEVICE_STACK=y
          CONFIG_USB_DEVICE_PRODUCT="HCI UART over CDC"
          CONFIG_USB_CDC_ACM=y
          
          # 将蓝牙 HCI 绑定到虚拟串口
          CONFIG_BT_UART=y
          CONFIG_UART_INTERRUPT_DRIVEN=y
          
          # 禁用流控 (防止死锁)
          CONFIG_UART_0_ENHANCED_POLL_OUT=y
          
          # 禁用日志和控制台 (关键！避免 Log 混入 HCI 协议流)
          CONFIG_LOG=n
          CONFIG_CONSOLE=n
          CONFIG_UART_CONSOLE=n
          CONFIG_PRINTK=n
          EOF

          # 2. 创建设备树覆盖 (将 bt-uart 指向 USB CDC)
          cat <<EOF > custom_overlay/app.overlay
          / {
              chosen {
                  zephyr,bt-uart = &cdc_acm_uart0;
              };
          };
          &zephyr_udc0 {
              cdc_acm_uart0: cdc_acm_uart0 {
                  compatible = "zephyr,cdc-acm-uart";
              };
          };
          EOF

          # 3. 执行编译
          # 确保使用绝对路径引用 overlay，防止路径解析错误
          west build -b nrf52840dongle/nrf52840 zephyr/samples/bluetooth/hci_uart -- -DOVERLAY_CONFIG=$(pwd)/custom_overlay/overlay.conf -DDTC_OVERLAY_FILE=$(pwd)/custom_overlay/app.overlay

      - name: Upload Hex
        uses: actions/upload-artifact@v4
        with:
          name: zephyr-hci-cdc
          path: zephyr-workspace/build/zephyr/zephyr.hex
